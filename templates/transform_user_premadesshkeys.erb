<%=
allPremadeKeys = {}

# Hiera will have already ensured these are unique per user, so this pass can be
# more lax.
scope.lookupvar("trivial_resources::users::normalUsers").each{|userName, userProps|
  # Skip deleted users
  if userProps and userProps["ensure"] and userProps["ensure"] != "present"
    next
  end

  if userProps and userProps["sshAuthorizedKeys"]
    userProps["sshAuthorizedKeys"].each{|keyName, keyProps|
      resourceName = userName + "_" + keyName
      allPremadeKeys[resourceName] = keyProps
      allPremadeKeys[resourceName]["user"] = userName
    }
  end
}

allPremadeKeys.to_yaml
%>
